<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opening WriteOffGenie...</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta property="og:title" content="Join WriteOffGenie">
    <meta property="og:description" content="Tap to complete your signup.">
    <meta property="og:image" content="https://writeoffgenie.ai/logo_writeoffgenie.png">

    <style>
        body {
            font-family: -apple-system, system-ui, Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f9fafb;
            text-align: center;
            padding: 20px;
        }
        .logo { width: 80px; height: 80px; margin-bottom: 24px; }
        .spinner {
            border: 3px solid rgba(1, 28, 57, 0.1);
            width: 32px; height: 32px; border-radius: 50%;
            border-left-color: #011C39;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h2 { color: #011C39; margin: 0 0 10px 0; font-size: 20px; font-weight: 600; }
        p { color: #6b7280; font-size: 14px; margin: 0 0 30px 0; max-width: 300px; line-height: 1.5; }
        .btn {
            display: none; /* Hidden by default */
            padding: 12px 30px;
            background-color: #011C39; color: white;
            text-decoration: none; border-radius: 8px;
            font-weight: 500; font-size: 15px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn:hover {
            background-color: #023057;
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>

    <img src="../favicon_writeoffgenie.svg" alt="Logo" class="logo" onerror="this.style.display='none'">
    
    <div class="spinner"></div>
    <h2 id="status">Launching App...</h2>
    <p id="sub-status">Connecting your invite code.</p>

    <a id="manual-btn" href="#" class="btn">Try Open App Again</a>

    <script>
        // --- 1. CONFIGURATION ---
        const SCHEME_PREFIX = "writeoffgenie://writeoffgenie.com/signuppage";

        // --- 2. LOGIC ---
        const params = new URLSearchParams(window.location.search);
        let rawCode = params.get('ref') || params.get('code') || '';
        const refCode = encodeURIComponent(rawCode);
        
        // Build the deep link
        const deepLink = `${SCHEME_PREFIX}?ref=${refCode}`;
        
        // Setup Button (In case they need to click manually)
        const btn = document.getElementById('manual-btn');
        btn.href = deepLink;

        // Button click handler - just open the app
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            tryOpenApp();
        });

        // Track if app opened successfully
        let appOpened = false;
        let startTime = Date.now();

        // Detect if user left page (app likely opened)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                appOpened = true;
            }
        });

        // Detect if window lost focus (app opened)
        window.addEventListener('blur', () => {
            appOpened = true;
        });

        // Function to try opening the app
        function tryOpenApp() {
            appOpened = false;
            startTime = Date.now();
            
            // Method 1: Direct link (works on Android, newer iOS)
            window.location.href = deepLink;
            
            // Method 2: iframe fallback for iOS
            setTimeout(() => {
                if (!appOpened) {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = deepLink;
                    document.body.appendChild(iframe);
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 500);
                }
            }, 300);
        }

        // --- EXECUTION ---
        
        // 1. Try to open the app immediately
        tryOpenApp();

        // 2. Wait 3 seconds. If the page is still visible and app didn't open, show fallback.
        setTimeout(() => {
            const elapsed = Date.now() - startTime;
            
            // If app opened (user left page), do nothing
            if (appOpened || document.hidden) {
                return;
            }
            
            // If we're still here after 3 seconds, app didn't open
            if (elapsed >= 2800) {
                // Update UI to show "App not present"
                document.getElementById('status').innerText = "App not installed?";
                document.getElementById('sub-status').innerText = "Please install the WriteOffGenie app first, then click the button below.";
                
                // Hide spinner, show manual button
                document.querySelector('.spinner').style.display = 'none';
                btn.style.display = "inline-block";
                btn.textContent = "Open WriteOffGenie App";
            }
            
        }, 3000);

    </script>
</body>
</html>